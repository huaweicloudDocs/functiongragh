# 获取请求认证<a name="functiongraph_06_0240"></a>

调用接口有如下两种认证方式，您可以选择其中一种进行认证鉴权。

-   Token认证：通过Token认证通用请求。
-   AK/SK认证：通过AK（Access Key ID）/SK（Secret Access Key\)加密调用请求。推荐使用AK/SK认证，其安全性比Token认证要高。

## Token认证<a name="section79321317315"></a>

当您使用Token认证方式完成认证鉴权时，需要获取用户Token并在调用接口时增加“X-Auth-Token”到业务接口请求消息头中。

1.  发送“POST https://**_IAM__的Endpoint_**/v3/auth/tokens”，获取IAM的Endpoint及消息体中的区域名称。

    请参考[地区和终端节点](http://developer.huaweicloud.com/endpoint.html)。

    请向企业管理员获取区域和终端节点信息。

    请求内容示例如下：

    >![](public_sys-resources/icon-note.gif) **说明：**   
    >下面示例代码中的"password"和"name"需要替换为实际内容，详情请参考[《统一身份认证服务API参考》](https://support.huaweicloud.com/api-iam/zh-cn_topic_0057845583.html)。  

    ```
    { 
      "auth": { 
        "identity": { 
          "methods": [ 
            "password" 
          ], 
          "password": { 
            "user": { 
              "name": "username", 
              "password": "password", 
              "domain": { 
                "name": "domainname" 
              } 
            } 
          } 
        }, 
        "scope": { 
          "project": { 
            "name": "cn-north-1aaa" //假设区域名称是"cn-north-1aaa"
          } 
        } 
      } 
    }
    ```

2.  <a name="li674772544818"></a>获取Token，请参考[《统一身份认证服务API参考》](https://support.huaweicloud.com/api-iam/zh-cn_topic_0057845563.html)的“Token认证”章节。请求响应成功后在响应消息头中包含的“X-Subject-Token”的值即为Token值。
3.  调用业务接口，在请求消息头中增加“X-Auth-Token”，“X-Auth-Token”的取值为[2](#li674772544818)中获取的Token。

## AK/SK认证<a name="section155796310188"></a>

通过API网关向下层服务发送请求时，必须使用AK\(Access Key ID\)、SK\(Secret Access Key\)对请求进行签名。

>![](public_sys-resources/icon-note.gif) **说明：**   
>-   AK\(Access Key ID\)：访问密钥ID。与私有访问密钥关联的唯一标识符；访问密钥ID和私有访问密钥一起使用，对请求进行加密签名。  
>-   SK\(Secret Access Key\)：与访问密钥ID结合使用的密钥，对请求进行加密签名，可标识发送方，并防止请求被修改。  

## 生成AK、SK<a name="section1570214488396"></a>

1.  注册并登录管理控制台。
2.  单击用户名，在下拉列表中单击“我的凭证”。
3.  单击“管理访问密钥”。
4.  单击“新增访问密钥”，进入“新增访问密钥”页面。
5.  输入当前用户的登录密码。
6.  通过邮箱或者手机进行验证，输入对应的验证码。

    >![](public_sys-resources/icon-note.gif) **说明：**   
    >在统一身份服务中创建的用户，如果创建时未填写邮箱或者手机号，则只需校验登录密码。  

7.  单击“确定”，下载访问密钥。

    >![](public_sys-resources/icon-note.gif) **说明：**   
    >为防止访问密钥泄露，建议您将其保存到安全的位置。  


## 请求签名流程<a name="section129551318154010"></a>

**签名前的准备**

1.  下载API网关签名工具。

    下载地址：[http://esdk.huawei.com/ilink/esdk/download/HW\_456706](http://esdk.huawei.com/ilink/esdk/download/HW_456706)

2.  解压下载的压缩包。
3.  创建java工程，将解压出来的jar引用到依赖路径中。

**签名过程**

1.  <a name="l7cc818a44a304b998a40ddb2bcd11e57"></a>创建用于签名的请求com.cloud.sdk.DefaultRequest\(JAVA\)。
2.  设置DefaultRequest的目标API URL、HTTPS方法、内容等信息。
3.  对DefaultRequest进行签名：
    1.  调用SignerFactory.getSigner\(String serviceName, String regionName\)获取一个签名工具实现的实例。
    2.  调用Signer.sign\(Request<?\> request, Credentials credentials\)对[1](#l7cc818a44a304b998a40ddb2bcd11e57)创建的请求进行签名。

        以下代码展示了这个步骤：

        ```
         //选用签名算法，对请求进行签名 
        Signer signer = SignerFactory.getSigner(serviceName, region); 
        //对请求进行签名，request会发生改变 
        signer.sign(request, new BasicCredentials(this.ak, this.sk));
        ```


4.  把上步中签名产生的request转换为一个适合发送的请求，并将签名后request中的header信息放入新的request中。

    以Apache HttpClient为例，需要把DefaultRequest转换为HttpRequestBase，把签名后的DefaultRequest的header信息放入HttpRequestBase中。

    具体过程请查看“[示例代码](#section09271750124118)”中的AccessServiceImpl.java。


## 示例代码<a name="section09271750124118"></a>

下面代码展示了如何对一个请求进行签名，并通过HTTP Client发送一个HTTPS请求的过程：

代码分成三个类进行演示：

-   AccessService：抽象类，将GET/POST/PUT/DELETE归一成access方法。
-   Demo：运行入口，模拟用户进行GET/POST/PUT/DELETE请求。
-   AccessServiceImpl：实现access方法，具体与API网关通信的代码都在access方法中。

下面示例代码中的region和serviceName（英文服务名缩写），请参考[地区和终端节点](http://developer.huaweicloud.com/endpoint.html)。

**AccessService.java:**

```
package com.cloud.apigateway.sdk.demo; 

import java.io.InputStream; 
import java.net.URL; 
import java.util.Map; 

import org.apache.http.HttpResponse; 

import com.cloud.sdk.http.HttpMethodName; 

public abstract class AccessService { 

    protected String serviceName = null; 

    protected String region = null; 

    protected String ak = null; 

    protected String sk = null; 

    public AccessService(String serviceName, String region, String ak, String sk) { 
        this.region = region; 
        this.serviceName = serviceName; 
        this.ak = ak; 
        this.sk = sk; 
    } 

    public abstract HttpResponse access(URL url, Map<String, String> header, InputStream content, Long contentLength, 
        HttpMethodName httpMethod) throws Exception; 

    public HttpResponse access(URL url, Map<String, String> header, HttpMethodName httpMethod) throws Exception { 
        return this.access(url, header, null, 0l, httpMethod); 
    } 

    public HttpResponse access(URL url, InputStream content, Long contentLength, HttpMethodName httpMethod) 
        throws Exception { 
        return this.access(url, null, content, contentLength, httpMethod); 
    } 
    public HttpResponse access(URL url, HttpMethodName httpMethod) throws Exception { 
        return this.access(url, null, null, 0l, httpMethod); 
    } 

    public abstract void close(); 

    public String getServiceName() { 
        return serviceName; 
    } 

    public void setServiceName(String serviceName) { 
        this.serviceName = serviceName; 
    } 

    public String getRegion() { 
        return region; 
    } 

    public void setRegion(String region) { 
        this.region = region; 
    } 

    public String getAk() { 
        return ak; 
    } 

    public void setAk(String ak) { 
        this.ak = ak; 
    } 

    public String getSk() { 
        return sk; 
    } 

    public void setSk(String sk) { 
        this.sk = sk; 
    } 

}
```

**AccessServiceImpl.java:**

```
package com.cloud.apigateway.sdk.demo; 

import java.io.IOException; 
import java.io.InputStream; 
import java.net.URISyntaxException; 
import java.net.URL; 
import java.util.HashMap; 
import java.util.Map; 

import javax.net.ssl.SSLContext; 

import org.apache.http.Header; 
import org.apache.http.HttpHeaders; 
import org.apache.http.HttpResponse; 
import org.apache.http.client.methods.HttpDelete; 
import org.apache.http.client.methods.HttpGet; 
import org.apache.http.client.methods.HttpHead; 
import org.apache.http.client.methods.HttpPatch; 
import org.apache.http.client.methods.HttpPost; 
import org.apache.http.client.methods.HttpPut; 
import org.apache.http.client.methods.HttpRequestBase; 
import org.apache.http.conn.ssl.AllowAllHostnameVerifier; 
import org.apache.http.conn.ssl.SSLConnectionSocketFactory; 
import org.apache.http.conn.ssl.SSLContexts; 
import org.apache.http.conn.ssl.TrustSelfSignedStrategy; 
import org.apache.http.entity.InputStreamEntity; 
import org.apache.http.impl.client.CloseableHttpClient; 
import org.apache.http.impl.client.HttpClients; 

import com.cloud.sdk.DefaultRequest; 
import com.cloud.sdk.Request; 
import com.cloud.sdk.auth.credentials.BasicCredentials; 
import com.cloud.sdk.auth.signer.Signer; 
import com.cloud.sdk.auth.signer.SignerFactory; 
import com.cloud.sdk.http.HttpMethodName; 


public class AccessServiceImpl extends AccessService { 

 private CloseableHttpClient client = null; 

 public AccessServiceImpl(String serviceName, String region, String ak, 
   String sk) { 
  super(serviceName, region, ak, sk); 
 } 

 /** {@inheritDoc} */ 

 public HttpResponse access(URL url, Map<String, String> headers, 
   InputStream content, Long contentLength, HttpMethodName httpMethod) 
   throws Exception { 

  // Make a request for signing. 
  Request request = new DefaultRequest(this.serviceName); 
  try { 
   // Set the request address. 
   request.setEndpoint(url.toURI()); 

   String urlString = url.toString(); 

   String parameters = null; 

    if (urlString.contains("?")) { 
        parameters = urlString.substring(urlString.indexOf("?") + 1); 
        Map parametersmap = new HashMap<String, String>(); 

        if (null != parameters && !"".equals(parameters)) { 
                    String[] parameterarray = parameters.split("&"); 

                    for (String p : parameterarray) { 
                        String key = p.split("=")[0]; 
                        String value = p.split("=")[1]; 
                        parametersmap.put(key, value); 
                    } 
                    request.setParameters(parametersmap); 
          } 
     } 

  } catch (URISyntaxException e) { 
   // It is recommended to add logs in this place.  
   e.printStackTrace(); 
  } 
  // Set the request method. 
  request.setHttpMethod(httpMethod); 
  if (headers != null) { 
   // Add request header information if required.  
   request.setHeaders(headers); 
  } 
  // Configure the request content.  
  request.setContent(content); 

  // Select an algorithm for request signing. 
  Signer signer = SignerFactory.getSigner(serviceName, region); 
  // Sign the request, and the request will change after the signing. 
  signer.sign(request, new BasicCredentials(this.ak, this.sk)); 

  // Make a request that can be sent by the HTTP client. 
  HttpRequestBase httpRequestBase = createRequest(url, null, 
    request.getContent(), contentLength, httpMethod); 
  Map<String, String> requestHeaders = request.getHeaders(); 
  // Put the header of the signed request to the new request. 
  for (String key : requestHeaders.keySet()) { 
   if (key.equalsIgnoreCase(HttpHeaders.CONTENT_LENGTH.toString())) { 
    continue; 
   } 
   httpRequestBase.addHeader(key, requestHeaders.get(key)); 
  } 

  HttpResponse response = null; 
  SSLContext sslContext = SSLContexts.custom() 
    .loadTrustMaterial(null, new TrustSelfSignedStrategy()) 
    .useTLS().build(); 
  SSLConnectionSocketFactory sslSocketFactory = new SSLConnectionSocketFactory( 
    sslContext, new AllowAllHostnameVerifier()); 

  client = HttpClients.custom().setSSLSocketFactory(sslSocketFactory) 
    .build(); 
  // Send the request, and a response will be returned. 
  response = client.execute(httpRequestBase); 
  return response; 
 } 

 /** 
  * Make a request that can be sent by the HTTP client. 
  *  
  * @param url 
  *            specifies the API access path. 
  * @param header 
  *            specifies the header information to be added. 
  * @param content 
  *            specifies the body content to be sent in the API call. 
  * @param contentLength 
  *            specifies the length of the content. This parameter is optional. 
  * @param httpMethod 
  *            specifies the HTTP method to be used. 
  * @return specifies the request that can be sent by an HTTP client. 
  */ 
 private static HttpRequestBase createRequest(URL url, Header header, 
   InputStream content, Long contentLength, HttpMethodName httpMethod) { 

  HttpRequestBase httpRequest; 
  if (httpMethod == HttpMethodName.POST) { 
   HttpPost postMethod = new HttpPost(url.toString()); 

   if (content != null) { 
    InputStreamEntity entity = new InputStreamEntity(content, 
      contentLength); 
    postMethod.setEntity(entity); 
   } 
   httpRequest = postMethod; 
  } else if (httpMethod == HttpMethodName.PUT) { 
   HttpPut putMethod = new HttpPut(url.toString()); 
   httpRequest = putMethod; 

   if (content != null) { 
    InputStreamEntity entity = new InputStreamEntity(content, 
      contentLength); 
    putMethod.setEntity(entity); 
   } 
  } else if (httpMethod == HttpMethodName.PATCH) { 
   HttpPatch patchMethod = new HttpPatch(url.toString()); 
   httpRequest = patchMethod; 

   if (content != null) { 
    InputStreamEntity entity = new InputStreamEntity(content, 
      contentLength); 
    patchMethod.setEntity(entity); 
   } 
  } else if (httpMethod == HttpMethodName.GET) { 
   httpRequest = new HttpGet(url.toString()); 
  } else if (httpMethod == HttpMethodName.DELETE) { 
   httpRequest = new HttpDelete(url.toString()); 
  } else if (httpMethod == HttpMethodName.HEAD) { 
   httpRequest = new HttpHead(url.toString()); 
  } else { 
   throw new RuntimeException("Unknown HTTP method name: " 
     + httpMethod); 
  } 

  httpRequest.addHeader(header); 
  return httpRequest; 
 } 

 @Override 
 public void close() { 
  try { 
   if (client != null) { 
    client.close(); 
   } 
  } catch (IOException e) { 
   // It is recommended to add logs in this place.  
   e.printStackTrace(); 
  } 
 } 

}
```

**Demo.java:**

```
package com.cloud.apigateway.sdk.demo; 

import java.io.BufferedReader; 
import java.io.ByteArrayInputStream; 
import java.io.IOException; 
import java.io.InputStream; 
import java.io.InputStreamReader; 
import java.net.MalformedURLException; 
import java.net.URL; 

import org.apache.http.HttpResponse; 

import com.cloud.sdk.http.HttpMethodName; 


public class Demo { 

 //replace real region 
 private static final String region = "regionName"; 

 //replace real service name 
 private static final String serviceName = "serviceName"; 

 public static void main(String[] args) { 

  //replace real AK 
  String ak = "akString"; 
  //replace real SK 
  String sk = "skString"; 

  // get method 
  //replace real url 
  String url = "urlString"; 
  get(ak, sk, url); 

  // post method 
  //replace real url 
  String postUrl = "urlString"; 
  //replace real body 
  String postbody = "bodyString"; 
  post(ak, sk, postUrl, postbody); 

  // put method 
  //replace real body 
  String putbody = "bodyString"; 
  //replace real url 
  String putUrl = "urlString"; 
  put(ak, sk, putUrl, putbody); 

  // delete method 
  //replace real url 
  String deleteUrl = "urlString"; 
  delete(ak, sk, deleteUrl); 
 } 

 public static void put(String ak, String sk, String requestUrl, 
   String putBody) { 

  AccessService accessService = null; 
  try { 
   accessService = new AccessServiceImpl(serviceName, region, ak, sk); 
   URL url = new URL(requestUrl); 
   HttpMethodName httpMethod = HttpMethodName.PUT; 

   InputStream content = new ByteArrayInputStream(putBody.getBytes()); 
   HttpResponse response = accessService.access(url, content, 
     (long) putBody.getBytes().length, httpMethod); 

   System.out.println(response.getStatusLine().getStatusCode()); 


  } catch (Exception e) { 
   e.printStackTrace(); 
  } finally { 
   accessService.close(); 
  } 

 } 

 public static void patch(String ak, String sk, String requestUrl, 
   String putBody) { 

  AccessService accessService = null; 
  try { 
   accessService = new AccessServiceImpl(serviceName, region, ak, sk); 
   URL url = new URL(requestUrl); 
   HttpMethodName httpMethod = HttpMethodName.PATCH; 
   InputStream content = new ByteArrayInputStream(putBody.getBytes()); 
   HttpResponse response = accessService.access(url, content, 
     (long) putBody.getBytes().length, httpMethod); 

   System.out.println(convertStreamToString(response.getEntity() 
     .getContent())); 
  } catch (Exception e) { 
   e.printStackTrace(); 
  } finally { 
   accessService.close(); 
  } 

 } 

 public static void delete(String ak, String sk, String requestUrl) { 

  AccessService accessService = null; 

  try { 
   accessService = new AccessServiceImpl(serviceName, region, ak, sk); 
   URL url = new URL(requestUrl); 
   HttpMethodName httpMethod = HttpMethodName.DELETE; 

   HttpResponse response = accessService.access(url, httpMethod); 
   System.out.println(convertStreamToString(response.getEntity() 
     .getContent())); 
  } catch (Exception e) { 
   e.printStackTrace(); 
  } finally { 
   accessService.close(); 
  } 

 } 

 public static void get(String ak, String sk, String requestUrl) { 

  AccessService accessService = null; 

  try { 
   accessService = new AccessServiceImpl(serviceName, region, ak, sk); 
   URL url = new URL(requestUrl); 
   HttpMethodName httpMethod = HttpMethodName.GET; 
   HttpResponse response; 
   response = accessService.access(url, httpMethod); 
   System.out.println(convertStreamToString(response.getEntity() 
     .getContent())); 
  } catch (Exception e) { 
   e.printStackTrace(); 
  } finally { 
   accessService.close(); 
  } 

 } 

 public static void post(String ak, String sk, String requestUrl, 
   String postbody) { 

  AccessService accessService = new AccessServiceImpl(serviceName, 
    region, ak, sk); 
  URL url = null; 
  try { 
   url = new URL(requestUrl); 
  } catch (MalformedURLException e) { 
   e.printStackTrace(); 
  } 
  InputStream content = new ByteArrayInputStream(postbody.getBytes()); 
  HttpMethodName httpMethod = HttpMethodName.POST; 
  HttpResponse response; 

  try { 
   response = accessService.access(url, content, 
     (long) postbody.getBytes().length, httpMethod); 
   System.out.println(convertStreamToString(response.getEntity() 
     .getContent())); 
  } catch (Exception e) { 
   e.printStackTrace(); 
  } finally { 
   accessService.close(); 
  } 
 } 

 private static String convertStreamToString(InputStream is) { 
  BufferedReader reader = new BufferedReader(new InputStreamReader(is)); 
  StringBuilder sb = new StringBuilder(); 

  String line = null; 
  try { 
   while ((line = reader.readLine()) != null) { 
    sb.append(line + "\n"); 
   } 
  } catch (IOException e) { 
   e.printStackTrace(); 
  } finally { 
   try { 
    is.close(); 
   } catch (IOException e) { 
    e.printStackTrace(); 
   } 
  } 

  return sb.toString(); 
 } 

}
```

>![](public_sys-resources/icon-note.gif) **说明：**   
>1.  URI、AK、SK、HTTP METHOD是必须设置的参数。  
>2.  可通过request.addHeader\(\)添加头信息。  

